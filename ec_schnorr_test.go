package zillean

import (
	"encoding/hex"
	"fmt"
	"testing"

	. "github.com/smartystreets/goconvey/convey"
)

func TestECSchnorr_GeneratePrivateKey(t *testing.T) {
	Convey("returns the new private key from random seed", t, func() {
		result := NewECSchnorr().GeneratePrivateKey()
		So(result, ShouldHaveLength, 32)
		So(result, ShouldHaveSameTypeAs, []uint8{})
	})
}

func TestECSchnorr_GetPublicKey(t *testing.T) {
	Convey("returns the public key from the private key", t, func() {
		for _, vector := range testVectors {
			privKey, _ := hex.DecodeString(vector.privateKey)
			pubKey, _ := hex.DecodeString(vector.publicKey)
			So(NewECSchnorr().GetPublicKey(privKey, true), ShouldResemble, pubKey)
		}
	})
}

func TestECSchnorr_TrySign(t *testing.T) {
	Convey("returns the signature on a given message", t, func() {
		ecs := NewECSchnorr()
		privKey, _ := hex.DecodeString("0F494B8312E8D257E51730C78F8FE3B47B6840C59AAAEC7C2EBE404A2DE8B25A")
		pubKey, _ := hex.DecodeString("039E43C9810E6CC09F46AAD38E716DAE3191629534967DC457D3A687D2E2CDDC6A")
		k, _ := hex.DecodeString("532B2267C4A3054F380B3357339BDFB379E88366FE61B42ACA05F69BC3F6F54E")
		msg, _ := hex.DecodeString("A7F1D92A82C8D8FE434D98558CE2B347171198542F112D0558F56BD68807999248336241F30D23E55F30D1C8ED610C4B0235398184B814A29CB45A672ACAE548E9C5F1B0C4158AE59B4D39F6F7E8A105D3FEEDA5D5F3D9E45BFA6CC351E220AE0CE106986D61FF34A11E19FD3650E9B7818FC33A1E0FC02C44557AC8AB50C9B2DEB2F6B5E24C4FDD9F8867BDCE1FF261008E7897970E346207D75E47A158298E5BA2F56246869CC42E362A02731264E60687EF5309D108534F51F8658FB4F080B7CB19EE9AEBD718CC4FA27C8C37DFC1ADA5D133D13ABE03F021E9B1B78CCBD82F7FF2B38C6D48D01E481B2D4FAF7171805FD7F2D39EF4C4F19B9496E81DAB8193B3737E1B27D9C43957166441B93515E8F03C95D8E8CE1E1864FAAD68DDFC5932130109390B0F1FE5CA716805F8362E98DCCAADC86ADBED25801A9A9DCFA6264319DDAFE83A89C51F3C6D199D38DE10E660C37BE872C3F2B31660DE8BC95902B9103262CDB941F77376F5D3DBB7A3D5A387797FC4819A035ECA704CEDB37110EE7F206B0C8805AAEBF4963E7C4708CE8D4E092366E71792A8A3B2BBCDEE321B3E15380C541EF0930888969F7457AFE18588826A419D58311C1784B5484EECDB393F6A0ACA11B91DF0866B500B8DEE501FD7EB9BCE09A17D74124B4605ADFC0777BED9816D8D7E8488544A18D8045CB3283B0A752B881B5F500FADB59010E63D")
		r, s, err := ecs.trySign(privKey, pubKey, k, msg)
		So(err, ShouldBeNil)
		So(fmt.Sprintf("%x", r), ShouldEqual, "3af3d288e830e96ff8ed0769f45abda774cd989e2ae32ef9e985c8505f14ff98")
		So(fmt.Sprintf("%x", s), ShouldEqual, "e191eb14a70b5b53ada45afff4a04578f5d8bb2b1c8a22985ea159b53826cde7")
	})
}

func TestECSchnorr_Sign_And_Verify(t *testing.T) {
	Convey("sign and validate the signature", t, func() {
		ecs := NewECSchnorr()
		privKey := ecs.GeneratePrivateKey()
		pubKey := ecs.GetPublicKey(privKey, false)
		msg := []byte("message")
		r, s := ecs.Sign(privKey, pubKey, msg)
		So(ecs.Verify(r, s, pubKey, msg), ShouldBeTrue)
	})
}
